<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMP Analyser</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    
    <!-- Performance hints for faster loading -->
    <link rel="preload" href="js/loader.js" as="script">
    <link rel="preload" href="js/config.js" as="script">
    <link rel="preload" href="js/auth.js" as="script">
    <!-- Load environment variables from env.js (generated from .env file) -->
    <script src="env.js"></script>
    <!-- Note: window.ENV is now loaded from env.js which is generated from .env file -->
    <!-- All other files should read from window.AppConfig after config.js initializes it -->
    
    <!-- Script loader - handles all dependencies with defer -->
    <script src="js/loader.js" defer></script>
    
    <!-- Application initialization -->
    <script defer>
        // Hide spinner function - separated from page initialization
        function hideSpinner() {
            var spinner = document.getElementById('spinner-overlay');
            if (spinner) spinner.style.opacity = 0;
            setTimeout(function() {
                if (spinner) spinner.style.display = 'none';
            }, 400);
        }
        
        // Hide spinner when all resources are loaded
        window.addEventListener('load', hideSpinner);
        
        // Single initialization point after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application with all required scripts
            window.DMP_LOADER.initApp({
                loadAppJs: true,
                loadInitJs: true,
                callback: window.initializePageContent
            }).catch(error => {
                console.error('Failed to initialize application:', error);
                // Show error message to user
                var statusElement = document.getElementById('api-status');
                if (statusElement) {
                    statusElement.textContent = '❌ Initialization Failed';
                    statusElement.className = 'disconnected';
                }
                // Show error in the error container if available
                var errorContainer = document.getElementById('error-message');
                if (errorContainer) {
                    errorContainer.textContent = 'Application initialization failed: ' + (error.message || 'Unknown error');
                    errorContainer.style.display = 'block';
                }
                // Hide spinner even if initialization fails
                hideSpinner();
            });
        });
    </script>
    <!-- Styles -->
    <link rel="stylesheet" href="css/shared-styles.css">
    <style>
        #api-status {
            margin: 10px 0;
            padding: 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #api-status.connected {
            color: green;
        }
        #api-status.disconnected {
            color: red;
        }
        
        /* File upload styling */
        .form-group input[type="file"] {
            display: block;
            margin: 8px 0;
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Email input styling */
        .form-group input[type="email"] {
            display: block;
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Help text styling */
        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.85em;
            color: #666;
        }
        
        /* Notification info styling */
        .notification-info {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-left: 3px solid #17a2b8;
            border-radius: 3px;
        }
        
        .notification-info p {
            margin: 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .notification-info em {
            color: #6c757d;
            font-style: italic;
        }
        
        /* Email notification box styling */
        .email-notification-box {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f4f8;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        
        .email-notification-box svg {
            margin-right: 15px;
            color: #17a2b8;
        }
        
        .email-notification-box p {
            margin: 0;
            font-size: 1.1em;
        }
        
        /* Submit Another DMP button */
        #return-to-form-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        
        #return-to-form-btn:hover {
            background-color: #5a6268;
        }
        
        /* Simplified Tabs styling */
        .input-method-tabs {
            margin-bottom: 20px;
        }
        
        /* Tab styling */
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab-button {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            background: #f5f5f5;
            border: none;
            border-radius: 4px 4px 0 0;
            color: #6c757d;
            transition: background 0.2s;
            cursor: pointer;
            font-weight: 400;
            outline: none;
        }
        
        .tab-button:hover:not(.active) {
            background: #f8f9fa;
            color: #495057;
        }
        
        .tab-button.active {
            background: #fff;
            color: #0057b8;
            font-weight: 600;
            border-bottom: 2px solid #0057b8;
            margin-bottom: -2px;
        }
        
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background-color: #fff;
        }
        
        .tab-pane {
            display: none;
            padding: 20px;
        }
        
        .tab-pane.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Spinner overlay -->
    <div id="spinner-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- No-JS fallback message -->
    <noscript>
        <div style="padding: 20px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px; margin: 20px;">
            <h2>JavaScript Required</h2>
            <p>This application requires JavaScript to function properly. Please enable JavaScript in your browser settings and reload the page.</p>
            <p>The DMP Analyser needs JavaScript to securely authenticate with the API and process your data.</p>
        </div>
    </noscript>
    <div class="container">
        <!-- Include the navigation component -->
        <div id="navigation-placeholder"></div>
        <div class="grey-box">
            <div class="feedback-pdf-row">
                <div class="feedback-prompt">
                    Early version July 17, 2025 — try it out, check out our <a href="about.html#release-notes">what's new</a> and leave your feedback.
                </div>
                <div>
                    <a href="results.html?token=cce5c4a3-df48-429b-bf31-0b158de2f6cb" class="example-button">
                        Example Result
                    </a>
                </div>
            </div>
        </div>
        <div id="api-status"></div>
        <div id="analysis-form">
            <form id="dmp-form">
                <div class="input-method-tabs">
                    <div class="tab-buttons">
                        <button type="button" class="tab-button" data-tab="file-upload-tab" id="file-tab-btn">Upload PDF</button>
                        <button type="button" class="tab-button" data-tab="text-input-tab" id="text-tab-btn">Enter Text</button>
                    </div>
                    
                    <div class="tab-content">
                        <div id="file-upload-tab" class="tab-pane active">
                            <div class="form-group file-upload">
                                <label for="pdf-file">Upload your DMP document (PDF format):</label>
                                <input type="file" id="pdf-file" accept=".pdf" />
                                <small class="form-text">Maximum file size: 10MB</small>
                            </div>
                        </div>
                        
                        <div id="text-input-tab" class="tab-pane">
                            <div class="form-group">
                                <label for="text-input">Enter your DMP text:</label>
                                <textarea id="text-input" rows="10" placeholder="Copy and paste your DMP text here"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="user-email">Email:</label>
                    <input 
                      type="email" 
                      id="user-email" 
                      placeholder="Enter your email"
                      required
                    />
                    <small class="form-text">You'll receive an email when your analysis is ready</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group half">
                        <label for="checklist-select">Assessment Criteria:</label>
                        <select id="checklist-select">
                            <option value="finnish_dmp_evaluation" selected>Finnish DMP Evaluation (Full)</option>
                            <option value="finnish_dmp_evaluation_1domain">Finnish DMP Evaluation (1 Domain)</option>
                        </select>
                    </div>
                    <div class="form-group half">
                        <label for="config-select">Analysis Configuration:</label>
                        <select id="config-select">
                            <option value="Full-GPT4-turbo-preview" selected>Full GPT-4 Turbo</option>
                            <option value="Domains-only-GPT4-turbo">Domains-only GPT-4 Turbo</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="analysis-context">Additional context for the analysis:</label>
                    <textarea 
                      id="analysis-context" 
                      rows="4" 
                      placeholder="Add any additional context about the DMP that might help with the analysis"
                    ></textarea>
                </div>

                <!-- Error message container -->
                <div id="error-message" class="form-text text-danger" style="display:none; color: #dc3545; margin: 10px 0; padding: 10px; border: 1px solid #dc3545; border-radius: 4px; background-color: #f8d7da;"></div>
                
                <button type="submit" id="submit-btn">Run Analysis</button>
                
                <div class="info-box">
                    <p><strong>Note:</strong> This version uses the Finnish DMP evaluation criteria. We have processed it for AI analysis. <a href="#" id="download-checklist-btn">See PDF</a>. <br> The tool supports multiple assessment frameworks. Please contact us to add your own!</p>
                    <p><strong>Reference:</strong> DMPTuuli working group. (2021). <a href="https://doi.org/10.5281/zenodo.4762326" target="_blank">Finnish DMP evaluation guidance</a>. Zenodo.</p>
                </div>
            </form>
        </div>
        <div id="analysis-status" style="display: none;">
            <h2>Analysis Submitted</h2>
            <div class="spinner" style="margin: 20px auto; display: none;"></div>
            <p id="status-message">Your DMP analysis has been submitted successfully!</p>
            <div class="email-notification-box" style="display: none; align-items: center; background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px; color: #0057b8;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                <p style="margin: 0;">You will receive an email when your analysis is ready.</p>
            </div>
        </div>
        <div id="analysis-result" style="display: none;">
            <h2>Analysis In Progress</h2>
            <div class="grey-box">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0057b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    <p style="margin: 0; font-weight: bold;">Your analysis is being processed</p>
                </div>
                
                <p>This may take several minutes. You'll receive an email when results are ready.</p>
                
                <div class="shareable-link-container">
                    <p><strong>Results link</strong></p>
                    <div class="copy-link-box">
                        <input type="text" id="shareable-link" readonly>
                        <button id="copy-link-btn" class="copy-button" title="Copy to clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                    <p class="copy-success" id="copy-success-message">Link copied to clipboard!</p>
                </div>
            </div>
        </div>
            <hr>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 24px;">
                <img src="img/Cc-by-nc_icon.png" alt="Creative Commons BY-NC" style="height: 36px; width: auto;">
                <span style="font-size: 0.95em;">
                    This work is licensed under a 
                    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer">CC BY-NC 4.0</a>.
                </span>
            </div>
    </div>
    <!-- Script loader is already included in the head with proper defer attribute -->
    <script>
        // Page-specific initialization function that will be called by the loader
        window.initializePageContent = async function() {
            // Check API status and update UI
            if (typeof checkApiHealth === 'function') {
                checkApiHealth().then(isHealthy => {
                    const statusElement = document.getElementById('api-status');
                    if (statusElement) {
                        if (isHealthy) {
                            // Hide the status element when API is connected
                            statusElement.textContent = '';
                            statusElement.style.display = 'none';
                        } else {
                            // Only show when API is disconnected
                            statusElement.textContent = '❌ API Disconnected';
                            statusElement.className = 'disconnected';
                            statusElement.style.display = 'block';
                        }
                    }
                });
            }
            
            // Load the navigation component
            fetch('components/navigation.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navigation-placeholder').innerHTML = data;
            });
            
            // Tab functionality
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            // Set initial active tab
            document.getElementById('file-tab-btn').classList.add('active');
            
            // Add click event listeners to tab buttons
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding pane
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Clear the other input method when switching tabs
                    if (tabId === 'text-input-tab') {
                        document.getElementById('pdf-file').value = '';
                    } else if (tabId === 'file-upload-tab') {
                        document.getElementById('text-input').value = '';
                    }
                });
            });
            
            // Initialize API client with authentication
            const apiClient = new ApiClient(window.AppConfig.api.baseUrl);
            apiClient.useAuthentication(true);
            
            // Set up form submission handler
            const form = document.getElementById('dmp-form');
            const errorContainer = document.getElementById('error-message');
            
            // Helper function to show errors
            function showError(message) {
                if (errorContainer) {
                    errorContainer.textContent = message;
                    errorContainer.style.display = 'block';
                } else {
                    console.error('Error:', message);
                    alert('Error: ' + message);
                }
            }
            
            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    
                    // Clear any previous error messages
                    if (errorContainer) {
                        errorContainer.textContent = '';
                        errorContainer.style.display = 'none';
                    }
                    
                    // Get form elements
                    const fileInput = document.getElementById('pdf-file');
                    const textInput = document.getElementById('text-input');
                    const submitButton = document.getElementById('submit-btn');
                    const statusContainer = document.getElementById('analysis-status');
                    const statusMessage = document.getElementById('status-message');
                    
                    try {
                        // Validate inputs
                        if (fileInput.files.length > 0 && textInput.value.trim().length > 0) {
                            throw new Error('Please provide either a PDF file OR text input, not both.');
                        }
                        
                        if (fileInput.files.length === 0 && textInput.value.trim().length === 0) {
                            throw new Error('Please provide either a PDF file OR text input.');
                        }
                        
                        // Check file size if a file is uploaded (max 10MB)
                        if (fileInput.files.length > 0) {
                            const maxSizeBytes = 10 * 1024 * 1024; // 10MB
                            if (fileInput.files[0].size > maxSizeBytes) {
                                throw new Error('PDF file size exceeds the maximum allowed (10MB).');
                            }
                        }
                        
                        // Begin submission - update UI
                        if (submitButton) {
                            submitButton.disabled = true;
                            submitButton.textContent = 'Processing...';
                        }
                        
                        // Hide form container and show status container
                        document.getElementById('analysis-form').style.display = 'none';
                        if (statusContainer) {
                            statusContainer.style.display = 'block';
                            
                            // Show spinner inside status container
                            const spinnerElement = statusContainer.querySelector('.spinner');
                            if (spinnerElement) spinnerElement.style.display = 'block';
                            
                            // Hide email notification during submission
                            const emailBox = statusContainer.querySelector('.email-notification-box');
                            if (emailBox) emailBox.style.display = 'none';
                        }
                        
                        // Update status message
                        if (statusMessage) statusMessage.textContent = 'Submitting your analysis, please wait...';
                        
                        // Get form values
                        const userEmail = document.getElementById('user-email').value;
                        const checklistId = document.getElementById('checklist-select').value;
                        const configId = document.getElementById('config-select').value;
                        
                        // Validate required fields
                        if (!configId) {
                            throw new Error('Please select an analysis configuration');
                        }
                        
                        if (!checklistId) {
                            throw new Error('Please select assessment criteria');
                        }
                        
                        if (!userEmail) {
                            throw new Error('Please enter your email address');
                        }
                        
                        // Basic email validation
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(userEmail)) {
                            throw new Error('Please enter a valid email address');
                        }
                        
                        // Clear any previous results
                        const analysisResult = document.getElementById('analysis-result');
                        if (analysisResult) {
                            analysisResult.style.display = 'none';
                            const resultLink = document.getElementById('results-direct-link');
                            const shareableLink = document.getElementById('shareable-link');
                            if (resultLink) resultLink.href = '#';
                            if (shareableLink) shareableLink.value = '';
                        }
                        
                        // Create metadata object (used for both PDF and text submissions)
                        const metadata = {
                            source: 'web-ui',
                            timestamp: new Date().toISOString(),
                            browser: navigator.userAgent
                        };
                        
                        // Determine which endpoint to use based on input type
                        const isPdfUpload = fileInput.files && fileInput.files.length > 0;
                        let endpoint = isPdfUpload ? '/api/dmp/enriched-checklists/upload-pdf' : window.AppConfig.api.endpoints.analyze;
                        
                        let response;
                        
                        // Handle submission based on input type
                        if (isPdfUpload) {
                            try {
                                // Set endpoint for PDF upload
                                endpoint = '/api/dmp/enriched-checklists/upload-pdf';
                                
                                // Create FormData for PDF upload
                                const pdfFormData = new FormData();
                                
                                // Add the PDF file with the correct field name expected by the backend
                                pdfFormData.append('pdf_file', fileInput.files[0]);
                                
                                // Get analysis context if provided
                                const analysisContext = document.getElementById('analysis-context').value.trim();
                                if (analysisContext) {
                                    pdfFormData.append('analysis_context', analysisContext);
                                    console.log('Analysis Context:', analysisContext);
                                }
                                
                                // Add metadata fields individually with dot notation
                                Object.entries(metadata).forEach(([key, value]) => {
                                    pdfFormData.append(`metadata.${key}`, value);
                                });
                                
                                // Debug: Log what we're sending
                                console.log('PDF Upload Endpoint:', endpoint);
                                console.log('PDF File:', fileInput.files[0].name, '(', fileInput.files[0].size, 'bytes )');
                                console.log('Config ID:', configId);
                                console.log('Checklist ID:', checklistId);
                                console.log('User Email:', userEmail);
                                console.log('Metadata:', metadata);
                                
                                // Log form data contents (can't directly log FormData)
                                console.log('FormData Contents:');
                                for (const pair of pdfFormData.entries()) {
                                    console.log(pair[0] + ': ' + (pair[1] instanceof File ? `File: ${pair[1].name}` : pair[1]));
                                }
                                
                                // Build URL with required checklist_id as query parameter
                                const uploadUrl = new URL(`${window.AppConfig.api.baseUrl}${endpoint}`);
                                uploadUrl.searchParams.append('checklist_id', checklistId);
                                
                                // Add config_id as query parameter
                                uploadUrl.searchParams.append('config_id', configId);
                                
                                // Add user_email as query parameter to ensure it's properly received
                                uploadUrl.searchParams.append('user_email', userEmail);
                                console.log('Full Upload URL:', uploadUrl.toString());
                                
                                // Collect form data fields for logging
                                const formDataFields = {};
                                for (const pair of pdfFormData.entries()) {
                                    formDataFields[pair[0]] = pair[1] instanceof File ? 
                                        `File: ${pair[1].name} (${pair[1].size} bytes)` : pair[1];
                                }
                                
                                // Log full request details as JSON
                                console.log('Full Request Details:', JSON.stringify({
                                    url: uploadUrl.toString(),
                                    method: 'POST',
                                    headers: {
                                        'Authorization': 'Bearer [TOKEN]' // Don't log actual token
                                    },
                                    formData: formDataFields,
                                    queryParams: {
                                        checklist_id: checklistId,
                                        config_id: configId,
                                        user_email: userEmail
                                    }
                                }, null, 2));
                                
                                // Get auth token - with error handling
                                const token = await window.AuthModule.getAccessToken();
                                if (!token) {
                                    throw new Error('Failed to get authentication token. Please try again or contact support.');
                                }
                                
                                // Log the final URL right before making the request
                                console.log('Final Upload URL (right before fetch):', uploadUrl.toString());
                                
                                // Make the fetch request with authentication
                                const fetchResponse = await fetch(uploadUrl.toString(), {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: pdfFormData,
                                    credentials: 'include'  // Important for CORS with credentials
                                });
                                
                                if (!fetchResponse.ok) {
                                    // Try to get more details about the error
                                    const errorText = await fetchResponse.text();
                                    console.error('PDF Upload Error:', fetchResponse.status, errorText);
                                    throw new Error(`API error: ${fetchResponse.status} ${fetchResponse.statusText}\nDetails: ${errorText}`);
                                }
                                
                                // Parse the response
                                response = await fetchResponse.json();
                                console.log('PDF Upload Response:', response);
                            } catch (pdfError) {
                                console.error('PDF Upload Error:', pdfError);
                                throw pdfError; // Re-throw to be caught by the outer try-catch
                            }
                        } else {
                            try {
                                // Set endpoint for text analysis
                                endpoint = '/api/dmp/enriched-checklists/analyze';
                                
                                // Create request body according to API specification
                                const requestBody = {
                                    checklist_id: checklistId,
                                    text: textInput.value.trim(),
                                    config_id: configId || 'dmp_with_pdf',
                                    user_email: userEmail,
                                    metadata: metadata
                                };
                                
                                // Add analysis context if provided
                                const analysisContext = document.getElementById('analysis-context').value.trim();
                                if (analysisContext) {
                                    requestBody.analysis_context = analysisContext;
                                    console.log('Analysis Context:', analysisContext);
                                }
                                
                                // Debug: Log what we're sending
                                console.log('Text Analysis Endpoint:', endpoint);
                                console.log('Text Analysis Payload:', requestBody);
                                
                                // Log full request details as JSON
                                console.log('Text Analysis Request:', JSON.stringify({
                                    url: `${window.AppConfig.api.baseUrl}${endpoint}`,
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': 'Bearer [TOKEN]' // Don't log actual token
                                    },
                                    body: requestBody
                                }, null, 2));
                                
                                // Get auth token - with error handling
                                const token = await window.AuthModule.getAccessToken();
                                if (!token) {
                                    throw new Error('Failed to get authentication token. Please try again or contact support.');
                                }
                                
                                // Make the fetch request with authentication
                                const fetchResponse = await fetch(`${window.AppConfig.api.baseUrl}${endpoint}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify(requestBody),
                                    credentials: 'include'  // Important for CORS with credentials
                                });
                                
                                if (!fetchResponse.ok) {
                                    // Try to get more details about the error
                                    const errorText = await fetchResponse.text();
                                    console.error('Text Analysis Error:', fetchResponse.status, errorText);
                                    throw new Error(`API error: ${fetchResponse.status} ${fetchResponse.statusText}\nDetails: ${errorText}`);
                                }
                                
                                // Parse the response
                                response = await fetchResponse.json();
                                console.log('Text Analysis Response:', response);
                            } catch (textAnalysisError) {
                                console.error('Text Analysis Error:', textAnalysisError);
                                throw textAnalysisError; // Re-throw to be caught by the outer try-catch
                            }
                        }
                        
                        // Process the response
                        console.log('API Response:', response);
                        
                        // Handle different response formats safely
                        if (response) {
                            // Check for access_token (new API format)
                            if (response.access_token) {
                                // Show the result link with the access_token
                                const resultUrl = `https://green-plant-0d15bda03.6.azurestaticapps.net/results.html?token=${response.access_token}`;
                                const resultLink = document.getElementById('results-direct-link');
                                const shareableLink = document.getElementById('shareable-link');
                                const analysisResult = document.getElementById('analysis-result');
                                
                                if (resultLink) resultLink.href = resultUrl;
                                if (shareableLink) shareableLink.value = resultUrl;
                                
                                // Hide status and show result
                                if (statusContainer) statusContainer.style.display = 'none';
                                if (analysisResult) analysisResult.style.display = 'block';
                                
                                // Set up copy button
                                const copyBtn = document.getElementById('copy-link-btn');
                                const copyMsg = document.getElementById('copy-success-message');
                                
                                if (copyBtn && copyMsg && shareableLink) {
                                    // Remove any existing event listeners to prevent duplicates
                                    // Instead of cloning, remove old listeners and add new ones
                                    const copyHandler = () => {
                                        shareableLink.select();
                                        try {
                                            // Use modern clipboard API with fallback
                                            if (navigator.clipboard) {
                                                navigator.clipboard.writeText(shareableLink.value);
                                            } else {
                                                document.execCommand('copy');
                                            }
                                            copyMsg.style.display = 'block';
                                            setTimeout(() => {
                                                copyMsg.style.display = 'none';
                                            }, 3000);
                                        } catch (clipboardError) {
                                            console.error('Failed to copy:', clipboardError);
                                        }
                                    };
                                    
                                    // Remove old listeners by cloning without events but preserve the ID
                                    const newCopyBtn = copyBtn.cloneNode(false);
                                    copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);
                                    
                                    // Add the event listener with the once option for automatic cleanup
                                    newCopyBtn.addEventListener('click', copyHandler);
                                }
                                
                            }
                            // Check for token (legacy format)
                            else if (response.token) {
                                // Show the result link
                                const resultUrl = `https://green-plant-0d15bda03.6.azurestaticapps.net/results.html?token=${response.token}`;
                                const resultLink = document.getElementById('results-direct-link');
                                const shareableLink = document.getElementById('shareable-link');
                                const analysisResult = document.getElementById('analysis-result');
                                
                                if (resultLink) resultLink.href = resultUrl;
                                if (shareableLink) shareableLink.value = resultUrl;
                                
                                // Hide status and show result
                                if (statusContainer) statusContainer.style.display = 'none';
                                if (analysisResult) analysisResult.style.display = 'block';
                                
                                // Set up copy button
                                const copyBtn = document.getElementById('copy-link-btn');
                                const copyMsg = document.getElementById('copy-success-message');
                                
                                if (copyBtn && copyMsg && shareableLink) {
                                    // Remove any existing event listeners to prevent duplicates
                                    const copyHandler = () => {
                                        shareableLink.select();
                                        try {
                                            // Use modern clipboard API with fallback
                                            if (navigator.clipboard) {
                                                navigator.clipboard.writeText(shareableLink.value);
                                            } else {
                                                document.execCommand('copy');
                                            }
                                            copyMsg.style.display = 'block';
                                            setTimeout(() => {
                                                copyMsg.style.display = 'none';
                                            }, 3000);
                                        } catch (clipboardError) {
                                            console.error('Failed to copy:', clipboardError);
                                        }
                                    };
                                    
                                    // Remove old listeners by cloning without events but preserve the ID
                                    const newCopyBtn = copyBtn.cloneNode(false);
                                    copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);
                                    
                                    // Add the event listener
                                    newCopyBtn.addEventListener('click', copyHandler);
                                }
                                
                            } 
                            // Check for run_id (async processing)
                            else if (response.run_id) {
                                // Store the run_id for later use
                                localStorage.setItem('lastRunId', response.run_id);
                                
                                // Update the status message to show submission confirmation
                                if (statusMessage) {
                                    statusMessage.textContent = 'Your DMP analysis has been submitted successfully!';
                                }
                                
                                // Hide spinner and show email notification
                                if (statusContainer) {
                                    const spinner = statusContainer.querySelector('.spinner');
                                    if (spinner) spinner.style.display = 'none';
                                    
                                    const emailBox = statusContainer.querySelector('.email-notification-box');
                                    if (emailBox) emailBox.style.display = 'flex';
                                }
                                
                                // If we have an access token, store it
                                if (response.access_token) {
                                    localStorage.setItem('lastAccessToken', response.access_token);
                                }
                            }
                            // Generic success case
                            else {
                                // Show email notification
                                if (statusContainer) {
                                    const spinner = statusContainer.querySelector('.spinner');
                                    if (spinner) spinner.style.display = 'none';
                                    
                                    const emailBox = statusContainer.querySelector('.email-notification-box');
                                    if (emailBox) emailBox.style.display = 'flex';
                                }
                                
                                if (statusMessage) {
                                    statusMessage.textContent = 'Your analysis has been submitted. You will receive an email when it is ready.';
                                }
                            }
                        } else {
                            // No response case
                            throw new Error('No response received from the server');
                        }
                    } catch (error) {
                        console.error('Error during form submission:', error);
                        showError(error.message || 'An unexpected error occurred. Please try again.');
                        
                        // Show form again if there was an error
                        document.getElementById('analysis-form').style.display = 'block';
                        if (statusContainer) statusContainer.style.display = 'none';
                    } finally {
                        // Re-enable submit button
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = 'Run Analysis';
                        }
                        
                        // Hide spinner if submission failed
                        if (statusContainer) {
                            const spinnerElement = statusContainer.querySelector('.spinner');
                            if (spinnerElement) spinnerElement.style.display = 'none';
                        }
                    }
                });
            }
        }; // Close initializePageContent function
    </script>
</body>
</html>
