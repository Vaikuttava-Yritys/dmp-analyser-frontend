<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMP Analyser</title>
    
    <!-- Performance hints for faster loading -->
    <link rel="preload" href="js/loader.js" as="script">
    <link rel="preload" href="js/config.js" as="script">
    <link rel="preload" href="js/auth.js" as="script">
    <!-- Inject environment variables - Single source of truth -->
    <script>
        // This is the ONLY place where environment variables should be defined
        // All other files should read from window.AppConfig after config.js initializes it
        window.ENV = {
            // Environment
            NODE_ENV: 'development',
            DEBUG: 'true',
            
            // UI Configuration
            UI_DEBUG: 'true',
            SHOW_API_STATUS: 'true'
        };
    </script>
    
    <!-- Script loader - handles all dependencies with defer -->
    <script src="js/loader.js" defer></script>
    
    <!-- Application initialization -->
    <script defer>
        // Hide spinner function - separated from page initialization
        function hideSpinner() {
            var spinner = document.getElementById('spinner-overlay');
            if (spinner) spinner.style.opacity = 0;
            setTimeout(function() {
                if (spinner) spinner.style.display = 'none';
            }, 400);
        }
        
        // Hide spinner when all resources are loaded
        window.addEventListener('load', hideSpinner);
        
        // Single initialization point after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application with all required scripts
            window.DMP_LOADER.initApp({
                loadAppJs: true,
                loadInitJs: true,
                callback: window.initializePageContent
            }).catch(error => {
                console.error('Failed to initialize application:', error);
                // Show error message to user
                var statusElement = document.getElementById('api-status');
                if (statusElement) {
                    statusElement.textContent = '❌ Initialization Failed';
                    statusElement.className = 'disconnected';
                }
                // Show error in the error container if available
                var errorContainer = document.getElementById('error-message');
                if (errorContainer) {
                    errorContainer.textContent = 'Application initialization failed: ' + (error.message || 'Unknown error');
                    errorContainer.style.display = 'block';
                }
                // Hide spinner even if initialization fails
                hideSpinner();
            });
        });
    </script>
    <!-- Styles -->
    <link rel="stylesheet" href="css/shared-styles.css">
    <style>
        #api-status {
            margin: 10px 0;
            padding: 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #api-status.connected {
            color: green;
        }
        #api-status.disconnected {
            color: red;
        }
        
        /* File upload styling */
        .form-group input[type="file"] {
            display: block;
            margin: 8px 0;
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Email input styling */
        .form-group input[type="email"] {
            display: block;
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Help text styling */
        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.85em;
            color: #666;
        }
        
        /* Notification info styling */
        .notification-info {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-left: 3px solid #17a2b8;
            border-radius: 3px;
        }
        
        .notification-info p {
            margin: 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .notification-info em {
            color: #6c757d;
            font-style: italic;
        }
        
        /* Email notification box styling */
        .email-notification-box {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f4f8;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        
        .email-notification-box svg {
            margin-right: 15px;
            color: #17a2b8;
        }
        
        .email-notification-box p {
            margin: 0;
            font-size: 1.1em;
        }
        
        /* Submit Another DMP button */
        #return-to-form-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        
        #return-to-form-btn:hover {
            background-color: #5a6268;
        }
        
        /* Simplified Tabs styling */
        .input-method-tabs {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 0;
            border-bottom: 1px solid #dee2e6;
            width: 100%;
        }
        
        .tab-button {
            padding: 12px 24px;
            background-color: #f5f5f5;
            border: none;
            margin-right: 2px;
            cursor: pointer;
            font-weight: 400;
            transition: all 0.2s ease;
            border-radius: 4px 4px 0 0;
            color: #6c757d;
            position: relative;
            outline: none;
            text-align: left;
            width: auto;
        }
        
        .tab-button:hover {
            background-color: #f8f9fa;
            color: #495057;
        }
        
        .tab-button.active {
            background-color: #ffffff;
            color: #495057;
            font-weight: 600;
            border-bottom: 2px solid #6c757d;
            margin-bottom: -1px;
        }
        
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background-color: #fff;
        }
        
        .tab-pane {
            display: none;
            padding: 20px;
        }
        
        .tab-pane.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Spinner overlay -->
    <div id="spinner-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- No-JS fallback message -->
    <noscript>
        <div style="padding: 20px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px; margin: 20px;">
            <h2>JavaScript Required</h2>
            <p>This application requires JavaScript to function properly. Please enable JavaScript in your browser settings and reload the page.</p>
            <p>The DMP Analyser needs JavaScript to securely authenticate with the API and process your data.</p>
        </div>
    </noscript>
    <div class="container">
        <!-- Include the navigation component -->
        <div id="navigation-placeholder"></div>
        <h1>DMP Analyser</h1>
        <div class="grey-box">
            <div class="feedback-pdf-row">
                <div class="feedback-prompt">
                    Early version — try it out, be patient, and please share your <a href="feedback.html">feedback</a>.
                </div>
                <div>
                    <a href="results.html?token=c1435f05-1294-4767-b668-586bd90bae8e" class="example-button">
                        Example Result
                    </a>
                </div>
            </div>
        </div>
        <div id="api-status"></div>
        <div id="analysis-form">
            <form id="dmp-form">
                <div class="input-method-tabs">
                    <div class="tab-buttons">
                        <button type="button" class="tab-button" data-tab="file-upload-tab" id="file-tab-btn">Upload PDF</button>
                        <button type="button" class="tab-button" data-tab="text-input-tab" id="text-tab-btn">Enter Text</button>
                    </div>
                    
                    <div class="tab-content">
                        <div id="file-upload-tab" class="tab-pane active">
                            <div class="form-group file-upload">
                                <label for="pdf-file">Upload your DMP document (PDF format):</label>
                                <input type="file" id="pdf-file" accept=".pdf" />
                                <small class="form-text">Maximum file size: 10MB</small>
                            </div>
                        </div>
                        
                        <div id="text-input-tab" class="tab-pane">
                            <div class="form-group">
                                <label for="text-input">Enter your DMP text:</label>
                                <textarea id="text-input" rows="10" placeholder="Copy and paste your DMP text here"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="user-email">Email:</label>
                    <input 
                      type="email" 
                      id="user-email" 
                      placeholder="Enter your email"
                      required
                    />
                    <small class="form-text">You'll receive an email when your analysis is ready</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group half">
                        <label for="checklist-select">Assessment Criteria:</label>
                        <select id="checklist-select">
                            <option value="finnish_dmp_evaluation" selected>Finnish DMP Evaluation (Full)</option>
                            <option value="finnish_dmp_evaluation_1domain">Finnish DMP Evaluation (1 Domain)</option>
                        </select>
                    </div>
                    <div class="form-group half">
                        <label for="config-select">Analysis Configuration:</label>
                        <select id="config-select">
                            <option value="Full-GPT4-turbo-preview" selected>Full GPT-4 Turbo</option>
                            <option value="Domains-only-GPT4-turbo">Domains-only GPT-4 Turbo</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" id="submit-btn">Run Analysis</button>
                
                <div class="info-box">
                    <p><strong>Note:</strong> This version uses the Finnish DMP evaluation criteria. We have processed it for AI analysis. <a href="#" id="download-checklist-btn">See PDF</a>. <br> The tool supports multiple assessment frameworks. Please contact us to add your own!</p>
                    <p><strong>Reference:</strong> DMPTuuli working group. (2021). <a href="https://doi.org/10.5281/zenodo.4762326" target="_blank">Finnish DMP evaluation guidance</a>. Zenodo.</p>
                </div>
            </form>
        </div>
        <div id="analysis-status" style="display: none;">
            <h2>Analysis Submitted</h2>
            <p id="status-message">Your DMP analysis has been submitted successfully!</p>
            <div class="email-notification-box">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                <p>You will receive an email when your analysis is ready.</p>
            </div>
        </div>
        <div id="analysis-result" style="display: none;">
            <h2>Analysis Complete</h2>
            <div class="grey-box">
                <p>Your analysis is ready. View your results here:</p>
                <div class="result-link-container">
                    <a id="results-direct-link" href="#" class="primary-link" target="_blank">View Results</a>
                </div>
                
                <div class="shareable-link-container">
                    <p><strong>Shareable link:</strong></p>
                    <div class="copy-link-box">
                        <input type="text" id="shareable-link" readonly>
                        <button id="copy-link-btn" class="copy-button" title="Copy to clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                    <p class="copy-success" id="copy-success-message">Link copied to clipboard!</p>
                </div>
                
                <div class="pdf-export-container">
                    <button id="export-pdf-btn" class="export-button pdf-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px; vertical-align: text-bottom;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><polyline points="15 15 12 18 9 15"></polyline></svg>
                        PDF Report
                    </button>
                </div>
            </div>
        </div>
            <hr>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 24px;">
                <img src="img/Cc-by-nc_icon.png" alt="Creative Commons BY-NC" style="height: 36px; width: auto;">
                <span style="font-size: 0.95em;">
                    This work is licensed under a 
                    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer">CC BY-NC 4.0</a>.
                </span>
            </div>
    </div>
    <!-- Script loader is already included in the head with proper defer attribute -->
    <script>
        // Page-specific initialization function that will be called by the loader
        window.initializePageContent = async function() {
            // Check API status and update UI
            if (typeof checkApiHealth === 'function') {
                checkApiHealth().then(isHealthy => {
                    const statusElement = document.getElementById('api-status');
                    if (statusElement) {
                        if (isHealthy) {
                            statusElement.textContent = '✅ API Connected';
                            statusElement.className = 'connected';
                        } else {
                            statusElement.textContent = '❌ API Disconnected';
                            statusElement.className = 'disconnected';
                        }
                    }
                });
            }
            
            // Load the navigation component
            fetch('components/navigation.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navigation-placeholder').innerHTML = data;
            });
            
            // Tab functionality
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            // Set initial active tab
            document.getElementById('file-tab-btn').classList.add('active');
            
            // Add click event listeners to tab buttons
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding pane
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Clear the other input method when switching tabs
                    if (tabId === 'text-input-tab') {
                        document.getElementById('pdf-file').value = '';
                    } else if (tabId === 'file-upload-tab') {
                        document.getElementById('text-input').value = '';
                    }
                });
            });
            
            // Form validation and submission handling
            const form = document.getElementById('dmp-form');
            const submitButton = document.getElementById('submit-button');
            const resultContainer = document.getElementById('result-container');
            const errorContainer = document.getElementById('error-message');
            
            if (form) {
                form.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    // Clear previous errors
                    if (errorContainer) {
                        errorContainer.textContent = '';
                        errorContainer.style.display = 'none';
                    }
                    
                    // Get form data
                    const formData = new FormData(form);
                    const textInput = document.getElementById('text-input').value.trim();
                    const fileInput = document.getElementById('pdf-file');
                    
                    // Validate inputs
                    if (textInput === '' && (!fileInput.files || fileInput.files.length === 0)) {
                        if (errorContainer) {
                            errorContainer.textContent = 'Please provide either text input or upload a PDF file.';
                            errorContainer.style.display = 'block';
                        }
                        return;
                    }
                    
                    try {
                        // Disable submit button during processing
                        if (submitButton) {
                            submitButton.disabled = true;
                            submitButton.textContent = 'Processing...';
                        }
                        
                        // Show loading indicator
                        if (resultContainer) {
                            resultContainer.innerHTML = '<div class="spinner"></div><p>Analyzing data, please wait...</p>';
                            resultContainer.style.display = 'block';
                        }
                        
                        // Send data to API using authenticated client
                        const response = await apiClient.post('/api/analyze', formData);
                        
                        // Handle response
                        if (response.ok) {
                            const data = await response.json();
                            if (resultContainer) {
                                resultContainer.innerHTML = `<h3>Analysis Results</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                            }
                        } else {
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error('Form submission error:', error);
                        if (errorContainer) {
                            errorContainer.textContent = `Error: ${error.message || 'Failed to process request'}`;
                            errorContainer.style.display = 'block';
                        }
                        if (resultContainer) {
                            resultContainer.style.display = 'none';
                        }
                    } finally {
                        // Re-enable submit button
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = 'Submit';
                        }
                    }
                });
            }
        }; // Close initializePageContent function
    </script>
</body>
</html>
