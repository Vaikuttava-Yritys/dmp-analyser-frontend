<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMP Assessment Results</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/favicon.png">
    
    <!-- Preconnect to key domains -->
    <link rel="preconnect" href="https://dmp-apim.azure-api.net">
    <link rel="dns-prefetch" href="https://dmp-apim.azure-api.net">
    
    <!-- Load environment variables from env.js (generated from .env file) -->
    <script src="env.js"></script>
    
    <!-- Critical above-the-fold CSS -->
    <style>
        /* Base styles */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f8f8fa;
            margin: 0;
            padding: 0;
            color: #333;
            line-height: 1.6;
        }
        
        /* Container */
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 32px;
        }
        
        /* Typography */
        h1 {
            font-size: 2rem;
            margin-bottom: 24px;
            color: #0057b8;
            text-align: center;
        }
        
        .centered {
            text-align: center;
        }
        
        /* Spinner overlay */
        #spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        /* Loader animation */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0057b8;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error display */
        .error {
            padding: 20px;
            background-color: #fff0f0;
            border-left: 4px solid #ff3333;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
    
    <!-- Preload script for deferred CSS loading -->
    <script>
        // Function to load CSS files in order of importance
        function loadDeferredCSS() {
            const cssFiles = [
                'css/shared-styles.css',
                'css/tabs.css',
                'css/feedback-styles.css?v=1.1',
                'css/results-feedback.css?v=1.0'
            ];
            
            let loadedCount = 0;
            
            // Load each CSS file in sequence
            function loadNextCSS(index) {
                if (index >= cssFiles.length) return;
                
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = cssFiles[index];
                link.onload = function() {
                    loadedCount++;
                    // Load next CSS file after a small delay
                    setTimeout(() => loadNextCSS(index + 1), 50);
                };
                link.onerror = function() {
                    // Try next file even if this one fails
                    setTimeout(() => loadNextCSS(index + 1), 50);
                };
                document.head.appendChild(link);
            }
            
            // Start loading CSS files
            loadNextCSS(0);
        }
        
        // Start loading CSS after page starts rendering
        if (window.requestIdleCallback) {
            requestIdleCallback(loadDeferredCSS);
        } else {
            setTimeout(loadDeferredCSS, 1);
        }
    </script>
    
    <!-- Fallback for browsers with JavaScript disabled -->
    <noscript>
        <link rel="stylesheet" href="css/shared-styles.css">
        <link rel="stylesheet" href="css/feedback-styles.css?v=1.1">
        <link rel="stylesheet" href="css/tabs.css">
        <link rel="stylesheet" href="css/results-feedback.css?v=1.0">
    </noscript>
    
    <!-- Environment configuration - Single source of truth -->
    <script>
        // Initialize environment variables with defaults
        window.ENV = {
            // UI configuration
            DEBUG: false,
            SHOW_API_STATUS: true,
            
            // Feature flags
            ENABLE_FEEDBACK: true
        };
        
        // Note: AppConfig will be initialized by config.js
    </script>
    
    <!-- Load the script loader first -->
    <script src="js/loader.js"></script>
</head>
<body>
    <div id="spinner-overlay">
        <div class="spinner"></div>
    </div>
    <div class="container">
        <!-- Include the navigation component -->
        <div id="navigation-placeholder"></div>
        <div class="grey-box" style="margin-bottom: 15px;">
            <div class="feedback-prompt">
                <strong>Early version</strong> — Please leave feedback on analysis results. Thank you for your patience.
            </div>
        </div>
        
        <!-- Summary skeleton - immediately visible -->
        <div id="summary-skeleton">
            <h1 class="centered">DMP Assessment Results</h1>
            <div class="tab-section">
                <div id="overall-assessment">Loading summary...</div>
            </div>
            <div class="tab-section">
                <div id="analysis-info"></div>
            </div>
        </div>
        
        <!-- Error display -->
        <div id="error" class="error" style="display:none;">
            <p class="error-message"></p>
            <div id="debug-info" style="display:none;"></div>
        </div>
        
        <!-- Inline script for immediate summary rendering -->
        <script>
            // Immediately execute to render summary as fast as possible
            (async function() {
                try {
                    // Get token from URL
                    const token = new URLSearchParams(window.location.search).get('token');
                    if (!token) {
                        throw new Error('No access token provided');
                    }
                    
                    // Wait for AppConfig to be available
                    const waitForAppConfig = () => {
                        return new Promise((resolve) => {
                            if (window.AppConfig && window.AppConfig.api && window.AppConfig.api.baseUrl) {
                                resolve();
                            } else {
                                setTimeout(() => resolve(waitForAppConfig()), 50);
                            }
                        });
                    };
                    
                    // Wait for FeedbackRender to be available
                    const waitForFeedbackRender = () => {
                        return new Promise((resolve) => {
                            if (window.FeedbackRender) {
                                resolve();
                            } else {
                                setTimeout(() => resolve(waitForFeedbackRender()), 50);
                            }
                        });
                    };
                    
                    // Wait for ApiClient to be available
                    const waitForApiClient = () => {
                        return new Promise((resolve) => {
                            if (window.ApiClient) {
                                resolve();
                            } else {
                                setTimeout(() => resolve(waitForApiClient()), 50);
                            }
                        });
                    };
                    
                    // Wait for all dependencies
                    await Promise.all([waitForAppConfig(), waitForFeedbackRender(), waitForApiClient()]);
                    
                    // Configure ApiClient for authentication
                    window.ApiClient.useAuthentication(true);
                    
                    // Fetch minimal data needed for summary
                    console.log('Fetching summary data...');
                    let data;
                    try {
                        data = await window.ApiClient.get(`/api/dmp/enriched-checklists/access/${encodeURIComponent(token)}`);
                        
                        // Check if the response indicates results are not ready yet
                        if (!data || data.status === 'processing' || data.status === 'pending') {
                            throw new Error('Results are still being processed');
                        }
                    } catch (apiError) {
                        // Show a user-friendly notification
                        document.getElementById('error').style.display = 'block';
                        const errorMessage = document.querySelector('.error-message');
                        
                        if (apiError.message.includes('processing')) {
                            errorMessage.innerHTML = `
                                <div style="display: flex; align-items: center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0057b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                    <strong>Your analysis is still being processed</strong>
                                </div>
                                <p>The DMP analysis can take several minutes to complete. Please check back later or wait for the email notification.</p>
                            `;
                        } else if (apiError.response && apiError.response.status === 404) {
                            errorMessage.innerHTML = `
                                <div style="display: flex; align-items: center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff3333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    <strong>Results not found</strong>
                                </div>
                                <p>The requested analysis results could not be found. This may be because:</p>
                                <ul>
                                    <li>The analysis has not been completed yet</li>
                                    <li>The access token is invalid or has expired</li>
                                    <li>The analysis was deleted or never existed</li>
                                </ul>
                                <p>Please check your email for a notification when your results are ready.</p>
                            `;
                        } else {
                            errorMessage.innerHTML = `
                                <div style="display: flex; align-items: center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff3333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    <strong>Error loading results</strong>
                                </div>
                                <p>There was a problem loading the analysis results: ${apiError.message}</p>
                            `;
                        }
                        
                        // Hide spinner
                        document.getElementById('spinner-overlay').style.display = 'none';
                        throw apiError; // Re-throw to stop further execution
                    }
                    
                    // Render summary components immediately
                    console.log('Rendering summary components...');
                    window.FeedbackRender.renderOverallAssessment(data);
                    window.FeedbackRender.renderAnalysisInfo(data);
                    
                    // Hide spinner now that summary is visible
                    document.getElementById('spinner-overlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('spinner-overlay').style.display = 'none';
                    }, 300);
                    
                    // Start loading remaining content in the background
                    setTimeout(() => {
                        // Copy summary content to the tab structure for when tabs are shown
                        const overallAssessment = document.getElementById('overall-assessment').innerHTML;
                        const analysisInfo = document.getElementById('analysis-info').innerHTML;
                        
                        document.getElementById('summary-tab-overall-assessment').innerHTML = overallAssessment;
                        document.getElementById('summary-tab-analysis-info').innerHTML = analysisInfo;
                        
                        // Load remaining content
                        loadRemainingContent(data, data.run_id, token, data.checklist || {});
                    }, 100);
                } catch (error) {
                    console.error('Error in summary mini-app:', error);
                    document.getElementById('error').style.display = 'block';
                    document.querySelector('.error-message').textContent = `Error loading summary: ${error.message}`;
                    document.getElementById('spinner-overlay').style.display = 'none';
                }
            })();
        </script>
        
        <!-- Full results interface (hidden until loaded) -->
        <div id="results" style="display:none;">
            <!-- Tabs Navigation -->
            <div class="tabs-container">
                <ul class="tabs-nav" id="results-tabs">
                    <li><button class="tab-button active" data-tab="summary-tab">Summary</button></li>
                    <li><button class="tab-button" data-tab="domains-tab">Domain-level Results</button></li>
                    <li><button class="tab-button" data-tab="detailed-tab">Detailed Results</button></li>
                    <li><button class="tab-button" data-tab="feedback-tab">Feedback for Author</button></li>
                    <li><button class="tab-button" data-tab="pdf-tab"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px; vertical-align: text-bottom;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><polyline points="15 15 12 18 9 15"></polyline></svg>PDF Export</button></li>
                </ul>
                
                <!-- Tab Contents -->
                
                <!-- Summary Tab -->
                <div id="summary-tab" class="tab-content active">
                    <div class="tab-section">
                        <div id="summary-tab-overall-assessment"></div>
                    </div>
                    
                    <div class="tab-section">
                        <div id="summary-tab-analysis-info"></div>
                    </div>
                </div>
                
                <!-- Domain-level Results Tab -->
                <div id="domains-tab" class="tab-content">
                    <div id="domain-summaries"></div>
                </div>
                
                <!-- Detailed Results Tab -->
                <div id="detailed-tab" class="tab-content">
                    <div id="domains"></div>
                </div>
                
                <!-- Feedback for Author Tab -->
                <div id="feedback-tab" class="tab-content">
                    <div id="feedback-note"></div>
                </div>
                
                <!-- PDF Export Tab -->
                <div id="pdf-tab" class="tab-content">
                    <div class="pdf-export-container centered">
                        <h3>PDF Report Export</h3>
                        <p>The PDF report includes all the information from this assessment in a printable format:</p>
                        <ul class="pdf-features">
                            <li>Overall assessment and score</li>
                            <li>Domain-level results with compliance indicators</li>
                            <li>Detailed analysis of each domain</li>
                            <li>Specific feedback for the author</li>
                        </ul>
                        <p>The report can be shared with collaborators or used for documentation purposes.</p>
                        <button id="export-pdf" class="export-button pdf-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px; vertical-align: text-bottom;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><polyline points="15 15 12 18 9 15"></polyline></svg>
                            Download PDF Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div style="display: flex; align-items: center; gap: 10px; margin-top: 24px;">
            <img src="img/Cc-by-nc_icon.png" alt="Creative Commons BY-NC" style="height: 36px; width: auto;">
            <span style="font-size: 0.95em;">
                This work is licensed under a 
                <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer">CC BY-NC 4.0</a>.
            </span>
        </div>
    </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
<!-- Load environment variables from env.js (generated from .env file) -->
<script src="env.js"></script>
<!-- Load scripts using centralized loader -->
<script src="js/loader.js"></script>
<script>
    // Initialize the application using the centralized loader
    function initResultsPage() {
        console.log('Initializing results page with AppConfig:', window.AppConfig);
        
        // Initialize the results page functionality
        if (window.ResultsFeedback) {
            const token = getTokenFromUrl();
            if (token) {
                window.token = token;
                window.ResultsFeedback.init(token);
            } else {
                showError('No access token provided. Please use a valid results link.');
            }
        } else {
            console.error('ResultsFeedback module not available');
            showError('Failed to load required modules. Please try refreshing the page.');
        }
    }
    
    // Show error message
    function showError(message) {
        const errorElement = document.getElementById('error');
        const errorMessageElement = document.querySelector('.error-message');
        const loadingElement = document.getElementById('loading');
        
        if (errorElement && errorMessageElement) {
            errorMessageElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }
    
    // Load all required scripts and initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        // Make sure the loader is available
        if (!window.DMP_LOADER) {
            console.error('DMP_LOADER not found. Make sure loader.js is loaded first.');
            showError('Failed to initialize application: Script loader not found');
            return;
        }

        // Initialize the application using the centralized loader
        window.DMP_LOADER.initApp({
            loadAppJs: false,
            loadInitJs: false,
            callback: async function() {
                try {
                    // Initialize API client with authentication
                    if (window.ApiClient) {
                        window.ApiClient.useAuthentication(true);
                        console.log('API client configured to use authentication');
                    } else {
                        throw new Error('API client not available after core scripts loaded');
                    }
                    
                    // Load additional modules needed for results page
                    await Promise.all([
                        window.DMP_LOADER.loadScript('js/feedback-data.js'),
                        window.DMP_LOADER.loadScript('js/feedback-api.js'),
                        window.DMP_LOADER.loadScript('js/results-feedback.js'),
                        window.DMP_LOADER.loadScript('js/feedback-render.js')
                    ]);
                    
                    // Initialize the results page
                    initResultsPage();
                } catch (err) {
                    console.error('Error in initialization callback:', err);
                    showError('Failed to initialize application: ' + err.message);
                }
            }
        }).catch(error => {
            console.error('Failed to initialize application:', error);
            showError('Application initialization failed: ' + error.message);
        });
    });
</script>
<script>
    // Debug check for loaded modules if debug is enabled
    if (window.AppConfig?.ui?.debug) {
        console.log('Modules loaded check:');
        console.log('FeedbackData available:', typeof FeedbackData !== 'undefined');
        console.log('FeedbackRender available:', typeof FeedbackRender !== 'undefined');
        console.log('FeedbackAPI available:', typeof FeedbackAPI !== 'undefined');
        console.log('ResultsFeedback available:', typeof ResultsFeedback !== 'undefined');
        console.log('ApiClient available:', typeof window.ApiClient !== 'undefined');
    }
</script>
<script>
    // Load the navigation component
    fetch('components/navigation.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('navigation-placeholder').innerHTML = data;
        });
        
    // Hide spinner when everything is loaded
    window.addEventListener('load', function() {
        var spinner = document.getElementById('spinner-overlay');
        if (spinner) spinner.style.opacity = 0;
        setTimeout(function() {
            if (spinner) spinner.style.display = 'none';
        }, 400);
    });
    
    // Tab functionality
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to current button and content
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // If this is the domains tab, ensure domain summaries are expanded
                if (tabId === 'domains-tab') {
                    // Wait for content to be rendered
                    setTimeout(() => {
                        // Find and disable the toggle button in domain summaries
                        const domainSummariesContent = document.querySelector('#domain-summaries-content');
                        const toggleButton = domainSummariesContent && domainSummariesContent.parentNode ? 
                            domainSummariesContent.parentNode.querySelector('.toggle-button') : null;
                        if (toggleButton) {
                            // Make sure content is visible
                            const contentDiv = document.getElementById('domain-summaries-content');
                            if (contentDiv) {
                                contentDiv.style.display = 'block';
                            }
                            // Hide the toggle button
                            toggleButton.style.display = 'none';
                        }
                    }, 100);
                }
            });
        });
        
        // Ensure domain summaries are expanded on initial load
        setTimeout(() => {
            const domainSummariesContent = document.getElementById('domain-summaries-content');
            if (domainSummariesContent) {
                domainSummariesContent.style.display = 'block';
                const toggleButton = domainSummariesContent.parentNode.querySelector('.toggle-button');
                if (toggleButton) {
                    toggleButton.style.display = 'none';
                }
            }
        }, 500);
    });
</script>

<script>
// --- Utility Functions --- //
function getTokenFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('token');
}

function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, function(tag) {
        const chars = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return chars[tag] || tag;
    });
}
function complianceClass(compliance) {
    if (!compliance) return 'compliance-Unknown';
    const c = compliance.toLowerCase();
    if (c.includes('full')) return 'compliance-FullyMet';
    if (c.includes('partial')) return 'compliance-PartiallyMet';
    if (c.includes('not')) return 'compliance-NotMet';
    return 'compliance-Unknown';
}

// --- Render Functions --- //
function renderManuscriptMetadata(data) {
    const container = document.getElementById('manuscript-metadata');
    
    // Get DMP metadata from summary or raw_outputs
    const summary = data.summary || {};
    let dmpMetadata = summary.dmp_metadata || {};
    
    // If not in summary, check raw_outputs as fallback
    if (!dmpMetadata || Object.keys(dmpMetadata).length === 0) {
        const rawOutputs = data.raw_outputs || {};
        dmpMetadata = rawOutputs.dmp_metadata || {};
    }
    
    // Get manuscript title from various possible locations
    let manuscriptTitle = '';
    if (dmpMetadata && dmpMetadata.title) {
        manuscriptTitle = dmpMetadata.title;
    } else if (data.title) {
        manuscriptTitle = data.title;
    } else if (data.manuscript_title) {
        manuscriptTitle = data.manuscript_title;
    } else {
        manuscriptTitle = 'Untitled Manuscript';
    }
    
    // Add manuscript title
    const titleElem = document.createElement('h3');
    titleElem.className = 'centered';
    titleElem.textContent = manuscriptTitle;
    container.appendChild(titleElem);
    
    // Add DMP metadata fields
    if (dmpMetadata) {
        // Add study design if available
        if (dmpMetadata.design) {
            const designElem = document.createElement('p');
            designElem.className = 'centered';
            designElem.textContent = `Study Design: ${dmpMetadata.design}`;
            container.appendChild(designElem);
        }
        
        // Add discipline if available
        if (dmpMetadata.discipline) {
            const disciplineElem = document.createElement('p');
            disciplineElem.className = 'centered';
            disciplineElem.textContent = `Discipline: ${dmpMetadata.discipline}`;
            container.appendChild(disciplineElem);
        }
    }
    
    // Add authors if available
    if (data.authors) {
        const authorsElem = document.createElement('p');
        let authorsText = '';
        if (Array.isArray(data.authors)) {
            authorsText = data.authors.join(', ');
        } else {
            authorsText = String(data.authors);
        }
        authorsElem.textContent = `Authors: ${authorsText}`;
        container.appendChild(authorsElem);
    }
    
    // Add DOI if available
    if (data.doi) {
        const doiElem = document.createElement('p');
        let doiText = '';
        if (typeof data.doi === 'object' && data.doi.$oid) {
            doiText = data.doi.$oid;
        } else {
            doiText = String(data.doi);
        }
        doiElem.textContent = `DOI: ${doiText}`;
        container.appendChild(doiElem);
    }
}

function renderAnalysisInfo(data) {
    const container = document.getElementById('analysis-info');
    
    // Check if we have enriched_data structure
    const enrichedData = data.enriched_data || {};
    
    // Add analysis date if available
    const createdAt = data.created_at;
    // Try to get timestamp from different possible locations
    let timestamp = enrichedData.timestamp || data.timestamp;
    
    if (timestamp) {
        // Handle MongoDB date format if present
        if (typeof timestamp === 'object' && timestamp.$date) {
            timestamp = timestamp.$date;
        }
        const formattedDate = new Date(timestamp).toLocaleDateString();
        const dateElem = document.createElement('p');
        dateElem.className = 'metadata-item';
        dateElem.textContent = `Analysis Date: ${formattedDate}`;
        container.appendChild(dateElem);
    } else if (createdAt) {
        // Fallback to created_at
        let dateStr = createdAt;
        if (typeof createdAt === 'object' && createdAt.$date) {
            dateStr = createdAt.$date;
        }
        const formattedDate = new Date(dateStr).toLocaleDateString();
        const dateElem = document.createElement('p');
        dateElem.className = 'metadata-item';
        dateElem.textContent = `Analysis Date: ${formattedDate}`;
        container.appendChild(dateElem);
    }
    
    // Add run ID information
    const runId = enrichedData.run_id || data.run_id;
    if (runId) {
        const runIdElem = document.createElement('p');
        runIdElem.className = 'metadata-item';
        runIdElem.textContent = `Analysis ID: ${runId}`;
        container.appendChild(runIdElem);
    } else if (data._id) {
        // Fallback to _id
        let idStr = data._id;
        if (typeof data._id === 'object' && data._id.$oid) {
            idStr = data._id.$oid;
        }
        const idElem = document.createElement('p');
        idElem.className = 'metadata-item';
        idElem.textContent = `Analysis ID: ${idStr}`;
        container.appendChild(idElem);
    }
    
    // Add configuration information
    const configId = enrichedData.config_id || data.config_id;
    if (configId) {
        const configElem = document.createElement('p');
        configElem.className = 'metadata-item';
        configElem.textContent = `Configuration: ${configId}`;
        container.appendChild(configElem);
    }
}

// Helper function to escape HTML for safe insertion
function escapeHTML(str) {
    if (!str) return '';
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function renderFeedbackNote(note) {
    const feedbackNoteElement = document.getElementById('feedback-note');
    if (feedbackNoteElement) {
        console.log('Rendering feedback note:', note);
        
        // Create header for the feedback section
        let content = '<h2 class="section-header">Feedback for Author</h2>';
        
        // Add the feedback note if available
        if (note) {
            content += '<div class="feedback-note-container">';
            content += escapeHTML(note).replace(/\n/g, '<br>');
            content += '</div>';
        } else {
            content += '<div class="feedback-note-container"><em>No author feedback note was provided for this assessment.</em></div>';
        }
        
        // Add overall feedback UI at the end of the feedback note section
        content += '<div id="author-overall-feedback"></div>';
        
        feedbackNoteElement.innerHTML = content;
        
        // Add overall feedback UI if available
        if (typeof ResultsFeedback !== 'undefined') {
            ResultsFeedback.addOverallFeedbackUI(document.getElementById('author-overall-feedback'));
        }
    } else {
        console.error('Feedback note element not found!');
    }
}

// --- PDF Export Function --- //
function setupPdfExport(token) {
    const exportButton = document.getElementById('export-pdf');
    if (!exportButton) return;

    exportButton.addEventListener('click', async () => {
        try {
            exportButton.disabled = true;
            exportButton.innerHTML = '<span style="margin-right: 5px;">⏳</span> Generating PDF...';
            
            // Make sure ApiClient is properly initialized with authentication
            if (!window.ApiClient) {
                throw new Error('API client not initialized');
            }
            
            // Ensure API client is using authentication
            window.ApiClient.useAuthentication(true);
            
            // Get the PDF URL
            const pdfEndpoint = `/api/dmp/enriched-checklists/access/${encodeURIComponent(token)}/export-pdf`;
            
            // Use the API client to get the PDF URL with authentication
            const pdfUrl = await window.ApiClient.getAuthenticatedUrl(pdfEndpoint);
            console.log('Generated authenticated PDF URL');
            
            // Open in new tab
            window.open(pdfUrl, '_blank');
            
            // Reset button after a delay
            setTimeout(() => {
                exportButton.disabled = false;
                exportButton.innerHTML = '<span style="margin-right: 5px;">📄</span> Download PDF Report';
            }, 2000);
        } catch (err) {
            console.error('Failed to export PDF:', err);
            exportButton.disabled = false;
            exportButton.innerHTML = '<span style="margin-right: 5px;">📄</span> Download PDF Report';
            alert('Failed to generate PDF. Please try again.');
        }
    });
}

// --- Main Logic --- //
function initResultsPage() {
    const token = getTokenFromUrl();
    // Store token globally for access by all modules
    window.token = token;
    
    if (!token) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').querySelector('.error-message').textContent = 'No token provided in URL.';
        return;
    }
    
    // Initialize the auth module with our configuration
    if (window.AuthModule) {
        console.log('Initializing AuthModule...');
        // Make sure we're using the correct auth proxy URL and token endpoint
        if (!window.AppConfig.auth.proxyUrl || !window.AppConfig.auth.tokenEndpoint) {
            console.error('Auth configuration is missing required properties');
        } else {
            console.log('Auth configuration:', window.AppConfig.auth);
        }
    } else {
        console.error('AuthModule not available!');
    }
    
    // Fetch data after ensuring auth and API client are ready
    fetchAndRenderData(token);
}

// Fetch and render data
async function fetchAndRenderData(token) {
    console.log('fetchAndRenderData called - delegating to mini-app approach');
    try {
        // This function is now just a compatibility wrapper
        // The actual rendering is handled by the inline mini-app script
        // and the loadRemainingContent function
        
        // Make sure ApiClient is properly initialized with authentication
        if (!window.ApiClient) {
            throw new Error('API client not initialized');
        }
        
        // Ensure API client is using authentication
        window.ApiClient.useAuthentication(true);
        
        // Fetch enriched checklist data using the API client
        console.log('Fetching enriched checklist data...');
        const data = await window.ApiClient.get(`/api/dmp/enriched-checklists/access/${encodeURIComponent(token)}`);
        
        // Normalize the data structure for consistent access
        const normalizedData = FeedbackData.normalizeData(data);
        
        // Get the run_id from the data or use the token as fallback
        const runId = normalizedData.analysis_id || 
                      normalizedData.run_id || 
                      data.run_id || 
                      token;
        
        // Store the run_id globally for access by all modules
        window.runId = runId;
        
        // Initialize checklist variable to avoid undefined error
        let checklist = normalizedData.checklist || {};
        
        // Render summary components
        FeedbackRender.renderOverallAssessment(normalizedData);
        FeedbackRender.renderAnalysisInfo(normalizedData);
        
        // Hide spinner
        if (document.getElementById('spinner-overlay')) {
            document.getElementById('spinner-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('spinner-overlay').style.display = 'none';
            }, 300);
        }
        
        // Load remaining content
        setTimeout(() => {
            loadRemainingContent(normalizedData, runId, token, checklist);
        }, 100);
        
    } catch (err) {
        console.error('Error loading analysis:', err);
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').querySelector('.error-message').textContent = `Failed to load analysis: ${err.message}`;
        document.getElementById('debug-info').style.display = 'block';
    }
}

// Function to load deferred CSS files during browser idle time
async function loadDeferredCSS() {
    const cssFiles = [
        'css/shared-styles.css',
        'css/feedback-styles.css',
        'css/tabs.css',
        'css/results-feedback.css'
    ];
    
    const loadCSS = (href) => {
        return new Promise((resolve) => {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href + '?v=' + (window.DMP_LOADER?.APP_VERSION || '1.0');
            link.onload = () => resolve();
            link.onerror = () => {
                console.error(`Failed to load CSS: ${href}`);
                resolve(); // Resolve anyway to not block other resources
            };
            document.head.appendChild(link);
        });
    };
    
    // Use requestIdleCallback if available, otherwise use setTimeout
    const requestIdleCallbackCompat = window.requestIdleCallback || 
        ((cb) => setTimeout(() => cb({ timeRemaining: () => 50 }), 1));
    
    // Load CSS files sequentially during idle time
    for (const cssFile of cssFiles) {
        await new Promise(resolve => {
            requestIdleCallbackCompat(() => {
                loadCSS(cssFile).then(resolve);
            });
        });
    }
    
    console.log('All deferred CSS files loaded');
}

// Function to load remaining content after summary is displayed
async function loadRemainingContent(normalizedData, runId, token, checklist = {}) {
    console.log('Loading remaining content...');
    try {
        // Load all deferred CSS files
        console.log('Loading deferred CSS files...');
        await loadDeferredCSS();
        
        // Initialize feedback system with the run_id
        if (typeof ResultsFeedback !== 'undefined' && typeof FeedbackAPI !== 'undefined') {
            ResultsFeedback.init(runId);
            console.log('ResultsFeedback initialized successfully with run_id:', runId);
        } else {
            console.error('ResultsFeedback or FeedbackAPI is not defined! Cannot initialize feedback system.');
        }
        
        // Fetch base checklist data if needed for additional context
        if (!checklist.sections && normalizedData.checklist_id) {
            try {
                console.log(`Fetching checklist using ApiClient: /api/dmp/checklists/${normalizedData.checklist_id}`);
                // Use ApiClient with authentication instead of fetch
                const checklist_data = await window.ApiClient.get(`/api/dmp/checklists/${normalizedData.checklist_id}`);
                if (checklist_data) {
                    checklist = checklist_data;
                    // Add the checklist to the normalized data
                    normalizedData.checklist = checklist;
                    console.log('Successfully fetched checklist data');
                }
            } catch (checklistErr) {
                console.warn('Failed to fetch base checklist:', checklistErr);
            }
        }
        
        // Hide the summary skeleton and show the full tabbed interface
        console.log('Transitioning from summary skeleton to full interface...');
        requestAnimationFrame(() => {
            // Show the full results container with tabs
            document.getElementById('results').style.display = 'block';
            // Hide the summary skeleton after a short delay to avoid flicker
            setTimeout(() => {
                document.getElementById('summary-skeleton').style.display = 'none';
            }, 100);
        });
        
        // Get feedback note from the data with detailed logging
        console.log('Looking for feedback note in data:', normalizedData);
        
        // Try multiple possible locations for the feedback note
        let feedbackNote = FeedbackData.safeGet(normalizedData, 'enriched_data.summary.feedback_note');
        console.log('Feedback note from enriched_data.summary.feedback_note:', feedbackNote);
        
        if (!feedbackNote) {
            feedbackNote = FeedbackData.safeGet(normalizedData, 'summary.feedback_note');
            console.log('Feedback note from summary.feedback_note:', feedbackNote);
        }
        
        if (!feedbackNote) {
            feedbackNote = FeedbackData.safeGet(normalizedData, 'feedback_note');
            console.log('Feedback note from feedback_note:', feedbackNote);
        }
        
        if (!feedbackNote) {
            feedbackNote = FeedbackData.safeGet(normalizedData, 'author_feedback');
            console.log('Feedback note from author_feedback:', feedbackNote);
        }
        
        if (!feedbackNote) {
            feedbackNote = FeedbackData.safeGet(normalizedData, 'summary.author_feedback');
            console.log('Feedback note from summary.author_feedback:', feedbackNote);
        }
        
        // If no feedback note is found, show a message that feedback was not found
        if (!feedbackNote) {
            console.log('No feedback note found in data');
            feedbackNote = 'Feedback for authors was not found.';
        }
        
        // Use the local renderFeedbackNote function instead of FeedbackRender module
        renderFeedbackNote(feedbackNote);
        
        // Directly render domains without checking ResultsFeedback availability
        console.log('Rendering domains...');
        // Render domain summaries and detailed domain analysis
        FeedbackRender.renderDomainSummaries(normalizedData);
        FeedbackRender.renderDomains(normalizedData, checklist);
        
        // Setup PDF export functionality
        setupPdfExport(token);
        
        // Update tab indicators based on results
        updateTabIndicators(normalizedData);
        
        // Note: ResultsFeedback is already initialized above
        
    } catch (err) {
        console.error('Error loading analysis:', err);
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').querySelector('.error-message').textContent = `Failed to load analysis: ${err.message}`;
        document.getElementById('debug-info').style.display = 'block';
    }
}

// Function to update tab indicators based on domain results
function updateTabIndicators(data) {
    // Get overall assessment classification
    let overallClassification = '';
    if (data.summary && data.summary.overall_classification) {
        overallClassification = data.summary.overall_classification.toLowerCase();
    }
    
    // Add indicator to domains tab
    const domainsTab = document.querySelector('[data-tab="domains-tab"]');
    if (domainsTab && overallClassification) {
        const indicator = document.createElement('span');
        indicator.className = `tab-indicator ${overallClassification}`;
        domainsTab.appendChild(indicator);
    }
    
    // Check if feedback exists and add indicator to feedback tab
    const feedbackNote = FeedbackData.safeGet(data, 'summary.feedback_note') || 
                        FeedbackData.safeGet(data, 'feedback_note');
    if (feedbackNote) {
        const feedbackTab = document.querySelector('[data-tab="feedback-tab"]');
        if (feedbackTab) {
            const indicator = document.createElement('span');
            indicator.className = 'tab-indicator';
            indicator.style.backgroundColor = '#3399cc';
            feedbackTab.appendChild(indicator);
        }
    }
}
</script>
</body>
</html>
