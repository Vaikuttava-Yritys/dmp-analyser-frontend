<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMP Prompts - Secure API Demo</title>
    
    <!-- Inject environment variables - Single source of truth -->
    <script>
      window.ENV = {
        AUTH_PROXY_URL:        'https://dmp-token-proxy.azurewebsites.net',
        AUTH_PROXY_TOKEN_ENDPOINT: '/token',
        AZURE_CLIENT_ID:       '2e93d7f3-7e47-4767-ac3b-9f19e9e57784',
        AZURE_TENANT_ID:       'f592cb5f-b8bc-41b9-901f-9a99ab84afa6',
        AZURE_API_SCOPE:       'api://2fb1d88c-02fe-4a8e-9f8d-dadbc9380dc3/.default'
      };
    </script>
    
    <!-- Script loader - handles all dependencies with defer -->
    <script src="js/loader.js" defer></script>
    
    <!-- Application initialization -->
    <script defer>
      // Define page-specific initialization function
      window.initializePageContent = async function() {
        // Page-specific initialization can go here
        console.log('Prompts page initialized');
        
        // Initialize the prompts interface after scripts are loaded
        if (typeof initializePromptsInterface === 'function') {
          await initializePromptsInterface();
        }
      };
      
      // Initialize the application when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        window.DMP_LOADER.initApp({
          loadAppJs: false,
          loadInitJs: false
        }).catch(error => {
          console.error('Failed to initialize prompts page:', error);
        });
      });
    </script>
    
    <!-- Load prompts API module -->
    <script src="js/prompts-api.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .api-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .api-status {
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .fetch-button {
            background-color: #28a745;
            color: white;
        }
        .refresh-token {
            background-color: #007bff;
            color: white;
        }
        .result-section {
            margin-top: 20px;
        }
        .result-container {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        .loading {
            color: #6c757d;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DMP Prompts - Secure API Demo</h1>
        
        <div class="api-section">
            <h2>API Connection Status</h2>
            <div id="api-status" class="api-status disconnected">Not connected to API</div>
            <div class="api-buttons">
                <button id="refresh-token" class="refresh-token">Refresh API Token</button>
            </div>
        </div>
        
        <div class="result-section">
            <h2>Prompts</h2>
            <button id="fetch-prompts" class="fetch-button">Fetch Prompts</button>
            <div id="result-container" class="result-container">
                <p>Click "Fetch Prompts" to retrieve data from the API.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // We're using AuthModule directly for authentication
            console.log('Initializing with AuthModule for authentication');
            
            // Initialize event listeners
            document.getElementById('refresh-token').addEventListener('click', refreshToken);
            document.getElementById('fetch-prompts').addEventListener('click', fetchPrompts);
            
            // Check API connection status
            checkApiStatus();
            
            // Function to refresh the API token
            async function refreshToken() {
                const statusElement = document.getElementById('api-status');
                statusElement.textContent = 'Refreshing token...';
                statusElement.className = 'api-status';
                
                try {
                    // Clear existing token and get a new one
                    AuthModule.clearTokenCache();
                    await AuthModule.getAccessToken();
                    statusElement.textContent = 'API token refreshed successfully';
                    statusElement.className = 'api-status connected';
                } catch (error) {
                    console.error('Token refresh failed:', error);
                    statusElement.textContent = 'Failed to refresh API token';
                    statusElement.className = 'api-status disconnected';
                }
            }
            
            // Check API connection status
            async function checkApiStatus() {
                const statusElement = document.getElementById('api-status');
                
                try {
                    // Try to get an access token
                    const token = await AuthModule.getAccessToken();
                    if (token) {
                        statusElement.textContent = 'Connected to API';
                        statusElement.className = 'api-status connected';
                    } else {
                        statusElement.textContent = 'Not connected to API';
                        statusElement.className = 'api-status disconnected';
                    }
                } catch (error) {
                    console.error('API connection check failed:', error);
                    statusElement.textContent = 'API connection error';
                    statusElement.className = 'api-status disconnected';
                }
            }
            
            // Function to fetch prompts from API
            async function fetchPrompts() {
                const resultContainer = document.getElementById('result-container');
                resultContainer.innerHTML = '<p class="loading">Loading prompts...</p>';
                
                try {
                    const prompts = await PromptsApi.getPrompts();
                    resultContainer.innerHTML = '<pre>' + JSON.stringify(prompts, null, 2) + '</pre>';
                    // Update API status after successful fetch
                    document.getElementById('api-status').textContent = 'Connected to API';
                    document.getElementById('api-status').className = 'api-status connected';
                } catch (error) {
                    console.error('Error fetching prompts:', error);
                    resultContainer.innerHTML = `<p class="error">Error: ${error.message || 'Failed to fetch prompts'}</p>`;
                    // Update API status after failed fetch
                    document.getElementById('api-status').textContent = 'API connection error';
                    document.getElementById('api-status').className = 'api-status disconnected';
                }
            }
        });
    </script>
</body>
</html>
